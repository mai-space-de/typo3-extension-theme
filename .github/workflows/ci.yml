name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ---------------------------------------------------------------------------
  # Validate composer.json
  # ---------------------------------------------------------------------------
  composer-validate:
    name: Composer validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          coverage: none

      - name: Validate composer.json
        run: composer validate --strict

  # ---------------------------------------------------------------------------
  # Unit tests (PHP 8.2 / 8.3 × TYPO3 13)
  # Tests PHP class logic: config loading, asset registration, backend theme.
  # ---------------------------------------------------------------------------
  unit-tests:
    name: "Unit tests · PHP ${{ matrix.php }} · TYPO3 ${{ matrix.typo3 }}"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        php: ["8.2", "8.3"]
        typo3: ["^13.0"]

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: gd, intl, mbstring, xml
          coverage: none
          tools: composer:v2

      - name: Install dependencies
        run: >
          composer require "typo3/cms-core:${{ matrix.typo3 }}" --no-update &&
          composer install
          --prefer-dist
          --no-progress
          --no-interaction
        env:
          COMPOSER_ROOT_VERSION: "1.0.0"

      - name: Run unit tests
        run: vendor/bin/phpunit --configuration phpunit.xml.dist --testsuite Unit --testdox

  # ---------------------------------------------------------------------------
  # Fluid template structure tests (PHP 8.3 only — no TYPO3 version matrix)
  # Verifies HTML structure, accessibility attributes, and Fluid wiring without
  # requiring a running TYPO3 instance. Catches missing tags and broken partials.
  # ---------------------------------------------------------------------------
  fluid-tests:
    name: Fluid template structure tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: gd, intl, mbstring, xml
          coverage: none
          tools: composer:v2

      - name: Install dependencies
        run: >
          composer install
          --prefer-dist
          --no-progress
          --no-interaction
        env:
          COMPOSER_ROOT_VERSION: "1.0.0"

      - name: Run Fluid template structure tests
        run: vendor/bin/phpunit --configuration phpunit.xml.dist --testsuite Fluid --testdox

  # ---------------------------------------------------------------------------
  # Static analysis
  # ---------------------------------------------------------------------------
  static-analysis:
    name: PHPStan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: gd, intl, mbstring, xml
          coverage: none
          tools: composer:v2

      - name: Install dependencies
        run: >
          composer install
          --prefer-dist
          --no-progress
          --no-interaction
        env:
          COMPOSER_ROOT_VERSION: "1.0.0"

      - name: Run PHPStan
        run: vendor/bin/phpstan analyse --no-progress

  # ---------------------------------------------------------------------------
  # Code style
  # ---------------------------------------------------------------------------
  code-style:
    name: PHP-CS-Fixer
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          coverage: none
          tools: composer:v2

      - name: Install dependencies
        run: >
          composer install
          --prefer-dist
          --no-progress
          --no-interaction
        env:
          COMPOSER_ROOT_VERSION: "1.0.0"

      - name: Check EditorConfig
        run: vendor/bin/ec -unv -e vendor/ -e public/

      - name: Check code style
        run: composer check:phpcs

  # ---------------------------------------------------------------------------
  # TypoScript lint
  # ---------------------------------------------------------------------------
  typoscript-lint:
    name: TypoScript lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          coverage: none
          tools: composer:v2

      - name: Install dependencies
        run: >
          composer install
          --prefer-dist
          --no-progress
          --no-interaction
        env:
          COMPOSER_ROOT_VERSION: "1.0.0"

      - name: Run TypoScript lint
        run: vendor/bin/typoscript-lint --fail-on-warnings -c typoscript-lint.yml Configuration/TypoScript/
